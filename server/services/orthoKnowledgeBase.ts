import type {
  HomeLearningAssistantMessageResponse,
  HomeLearningAssistantRecommendedExercise,
  HomeLearningAssistantRecommendedGame,
} from "@shared/api";

type KnowledgeBaseEntry = {
  id: string;
  question: string;
  keywords: string[];
  reply: string;
  simplified: string;
  cues: string[];
  nextActions: string[];
  personalizedTips: string[];
  recommendedGames: HomeLearningAssistantRecommendedGame[];
  recommendedExercises?: HomeLearningAssistantRecommendedExercise[];
};

const stripDiacritics = (value: string) =>
  value
    .normalize("NFD")
    .replace(/[\u064B-\u0652]/g, "")
    .normalize("NFC");

const normalizeText = (value: string) =>
  stripDiacritics(value)
    .toLowerCase()
    .replace(/["'،؛?.!؟]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

const tokenize = (value: string) => {
  if (!value) {
    return [] as string[];
  }
  const normalized = normalizeText(value);
  return normalized.length > 0 ? normalized.split(" ") : [];
};

const BASE_EXERCISES: HomeLearningAssistantRecommendedExercise[] = [
  {
    title: "تمرين المرآة الواعية",
    goal: "ضبط حركة اللسان والشفاه أثناء نطق الصوت المستهدف",
    instructions: [
      "قف مع طفلك أمام المرآة وحدد الصوت الذي تعملان عليه.",
      "انطق الصوت ببطء مع مبالغة في حركة اللسان والشفاه.",
      "اطلب من الطفل تقليدك ثلاث مرات متتالية ثم زيد السرعة تدريجياً.",
    ],
    durationMinutes: 5,
    materials: ["مرآة كبيرة", "بطاقات صوت"],
    difficulty: "سهل",
  },
  {
    title: "رحلة الأصوات في القصص",
    goal: "دمج الصوت المستهدف داخل سياق قصصي ممتع",
    instructions: [
      "اختر قصة قصيرة تحتوي على كلمات بالصوت المستهدف.",
      "اقرأ الجملة الأولى ثم توقف عند الكلمة المهمة واطلب من طفلك تكرارها.",
      "أعد الجملة كاملة معاً بنبرة مسرحية لتعزيز الطلاقة.",
    ],
    durationMinutes: 7,
    materials: ["قصة مصورة", "أقلام تلوين"],
    difficulty: "متوسط",
  },
  {
    title: "صيد الأصوات في البيت",
    goal: "رفع الوعي السمعي للصوت داخل كلمات الحياة اليومية",
    instructions: [
      "تجوّل مع طفلك في المنزل وابحثا عن أشياء تحتوي الصوت المستهدف.",
      "سجّلوا على ورقة اسم كل غرض ثم نطقوه ببطء مرتين.",
      "اختتموا التمرين بجملة من اختيار الطفل تضم الأشياء الثلاثة الأولى.",
    ],
    durationMinutes: 10,
    materials: ["ورقة", "أقلام", "ملصقات"],
    difficulty: "متوسط",
  },
  {
    title: "إيقاع التنفس والنطق",
    goal: "تنظيم التنفس قبل النطق لتقليل التلعثم",
    instructions: [
      "علّم الطفل نمط تنفّس: شهيق عدًّا إلى أربعة، حبس لثانيتين، زفير حتى ستة.",
      "بعد كل زفير انطق الصوت أو الكلمة المستهدفة بنبرة هادئة.",
      "كرروا الدورة خمس مرات ثم قيّموا الهدوء الذي شعر به الطفل.",
    ],
    durationMinutes: 6,
    difficulty: "سهل",
  },
  {
    title: "سلم الكلمات المتدرّج",
    goal: "الانتقال من الصوت المفرد إلى الجملة القصيرة بثقة",
    instructions: [
      "ابدأ بالصوت منفرداً لثلاث محاولات ناجحة.",
      "انتقل إلى مقطع ثنائي ثم كلمة تحتوي الصوت في البداية والوسط والنهاية.",
      "ابنِ مع الطفل جملة قصيرة من اختياركما تتضمن الكلمة واستمعا للتسجيل.",
    ],
    durationMinutes: 8,
    materials: ["بطاقات مقاطع", "جهاز تسجيل"],
    difficulty: "متوسط",
  },
  {
    title: "تمرين التمييز السمعي المزدوج",
    goal: "الفصل بين صوتين متقاربين (مثل س/ش أو ت/ط)",
    instructions: [
      "شغّل مقطعاً صوتياً قصيراً أو انطق صوتين متتاليين للطفل.",
      "اطلب منه رفع بطاقة اللون المناسبة للصوت الصحيح.",
      "انتقل إلى كلمات قصيرة تتضمن الصوتين ثم جمل بسيطة.",
    ],
    durationMinutes: 7,
    materials: ["بطاقات ألوان", "مكبر صوت"],
    difficulty: "متقدم",
  },
  {
    title: "مسرح الظل",
    goal: "تفعيل الخيال والحركة لدعم مخارج الحروف",
    instructions: [
      "حضّر دميات ورقية أو استخدم يديك لإسقاط ظلال على الجدار.",
      "اختر كلمات تحتوي الصوت المستهدف واجعل كل دمية تنطق كلمة مع حركة فم مبالغ بها.",
      "اطلب من الطفل تقليد الحركة والصوت ثم ابتكروا قصة قصيرة معاً.",
    ],
    durationMinutes: 9,
    materials: ["مصباح", "دميات ورقية"],
    difficulty: "متوسط",
  },
];

const DEFAULT_GAME: HomeLearningAssistantRecommendedGame = {
  title: "لعبة صائد الأصوات",
  objective: "ترسيخ النطق السليم للصوت المستهدف في كلمات معزولة ثم جمل قصيرة",
  overview: "ضع بطاقات لكلمات تحتوي الصوت واطلب من الطفل التقاط البطاقة بعد نطق الكلمة مرتين بشكل صحيح.",
  steps: [
    "حضّر ست بطاقات لكلمات مألوفة تضم الصوت الصعب.",
    "انطق الكلمة أولاً كنموذج ثم اطلب من الطفل تكرارها ببطء.",
    "إذا نطقها بشكل صحيح لمرتين، اسمح له بالاحتفاظ بالبطاقة كمكافأة.",
  ],
  materials: ["بطاقات كلمات", "سلة صغيرة"],
  durationMinutes: 8,
};

const KNOWLEDGE_BASE: KnowledgeBaseEntry[] = [
  {
    id: "q01-r-sound",
    question: "كيف أساعد طفلي على نطق حرف الراء بشكل أوضح؟",
    keywords: ["راء", "نطق", "ر", "اهتزاز"],
    reply:
      "ابدأ بتنشيط طرف اللسان عبر تدليك لطيف باستخدام عود قطني أو قطعة ثلج صغيرة، ثم اطلب من طفلك إطلاق صوت \"ددد\" سريع يتحول تدريجياً إلى اهتزاز \"ر\". انتقل بعدها إلى كلمات قصيرة مثل \"رمل\" و\"كرسي\" مستخدماً المرآة والبطء في النطق، مع تعزيز كل محاولة ناجحة بتشجيع لفظي وحركة تصفيق لتعزيز الثقة.",
    simplified: "نشّط طرف اللسان، استخدم صوْت \"دد\" للانتقال إلى \"ر\"، ثم كرر كلمات قصيرة أمام المرآة مع تشجيع.",
    cues: ["استخدم صوت \"دد\" لتوليد اهتزاز اللسان", "راقب طرف اللسان أمام المرآة", "خفّض سرعة النطق إلى النصف"],
    nextActions: [
      "نفّذ ثلاث جولات من تمرين المرآة الواعية مع التركيز على حرف الراء.",
      "انتقل إلى سلم الكلمات المتدرّج باستخدام كلمات تبدأ وتنتهي بحرف الراء.",
      "سجّل المحاولات الصوتية وناقش التحسّن مع الطفل مساءً.",
    ],
    personalizedTips: [
      "حافظ على جلسات قصيرة لا تتجاوز سبع دقائق لتفادي الإحباط.",
      "استخدم تشجيعاً حركياً مثل الملصقات أو التصفيق بعد كل نجاح.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q02-s-vs-sh",
    question: "طفلي يخلط بين صوتي السين والشين، ما الحل؟",
    keywords: ["سين", "شين", "تمييز", "س", "ش"],
    reply:
      "ابدأ بتمرين التمييز السمعي باستخدام أزواج من الكلمات مثل \"سور\" و\"شور\"، واعرض على طفلك بطاقات بلونين مختلفين ليرفع اللون الصحيح عند سماع الصوت. بعد ترسيخ التمييز، انتقل إلى تدريب النطق عبر وضع اللسان خلف الأسنان للسين ورفع اللسان قليلاً مع تدوير الشفتين للشين، مستخدماً المرآة والتكرار البطيء.",
    simplified: "ميّز الصوتين ببطاقات ملونة، ثم درّب وضع اللسان والشفتين ببطء أمام المرآة.",
    cues: ["استعمل بطاقات لونين للتمييز", "لسان خلف الأسنان للسين", "رفع اللسان وتدوير الشفتين للشين"],
    nextActions: [
      "شغّل تمرين التمييز السمعي المزدوج ثلاث مرات خلال الأسبوع.",
      "استخدم قصة قصيرة من رحلة الأصوات في القصص تركّز على كلمات بالسين والشين.",
      "اختتم الجلسة بجولة من لعبة صائد الأصوات مع كلمات مختلطة.",
    ],
    personalizedTips: [
      "حافظ على بيئة هادئة وخالية من المشتتات عند التدريب.",
      "أثنِ على دقة الإصغاء قبل تقييم النطق لتقوية الدافعية.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q03-lisp",
    question: "ابنتي تستبدل حرف السين بثاء، كيف أصحح ذلك؟",
    keywords: ["لدغة", "ثاء", "سين", "استبدال", "لدغة سينية"],
    reply:
      "عرّفي الطفلة على وضع اللسان الصحيح للسين باستخدام ملعقة صغيرة تلامس الأسنان الأمامية لمنع تقدّم اللسان. درّبيها على النفخ من فتحة ضيقة بين الأسنان لإنتاج صوت همس ثم أضيفي الصوت داخل مقاطع مثل \"سا\" و\"سي\" ببطء. سجّلا تقدّمها أسبوعياً لملاحظة تقلّص اللدغة.",
    simplified: "أوقفي تقدّم اللسان بملعقة، خرّجي هواءً من فتحة ضيقة، ثم درّبي المقاطع البطيئة.",
    cues: ["استخدمي ملعقة لمنع بروز اللسان", "ركّزي على هواء همس خفيف", "انتقلي من مقاطع إلى كلمات"],
    nextActions: [
      "كرري تمرين المرآة الواعية مع التركيز على موضع اللسان.",
      "ادمجي الصوت في سلم الكلمات المتدرّج من المقاطع إلى الجمل.",
      "اكتبي مع الطفلة قائمة كلمات تحتوي السين للممارسة اليومية.",
    ],
    personalizedTips: [
      "تجنّبي التصحيح العلني أمام الآخرين لحماية ثقتها.",
      "استخدمي تسجيلات صوتية قبل وبعد التمرين لملاحظة الفرق.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q04-stuttering-stress",
    question: "ابني يتلعثم عند التوتر، كيف أساعده في المنزل؟",
    keywords: ["تلعثم", "توتر", "طلاقة", "قلق"],
    reply:
      "هيئ روتيناً ثابتاً لتمارين التنفّس قبل أي حوار، مستخدماً نمط شهيق لأربع عدّات وزفير لست عدّات. درّبه على التحدث ببطء عبر قراءة بطاقات كلمات مع ترقيم، وعرّف العائلة على قاعدة الإصغاء دون مقاطعة. شجّعه على تسجيل تقدّمه الصوتي بنفسه ليشعر بالسيطرة على طلاقته.",
    simplified: "طبّق تنفساً منظماً، اقرأ ببطء باستخدام بطاقات مرقمة، وفعّل بيئة استماع داعمة.",
    cues: ["شهيق 4 عدّات وزفير 6 عدّات", "بطاقات كلمات بإيقاع ثابت", "تجنّب المقاطعة العائلية"],
    nextActions: [
      "طبّق تمرين إيقاع التنفس والنطق مرتين يومياً.",
      "جرّب مسرح الظل لتمثيل جمل قصيرة ببطء وتدرّج.",
      "سجّل مقطع فيديو تشجيعي بعد كل أسبوع لتوثيق الثقة.",
    ],
    personalizedTips: [
      "استخدم إشارات بصرية (رفع اليد) لإعلامه بأنه يمتلك وقت الكلام كاملًا.",
      "ذكّره بأن التلعثم ليس خطأً بل نمطاً يمكن تنظيمه.",
    ],
    recommendedGames: [
      {
        title: "ساعي البريد المتزن",
        objective: "التحدث بجمل قصيرة بإيقاع ثابت",
        overview: "يحمل الطفل بطاقات رسائل وينطق الجملة المكتوبة قبل إيصالها، مع الحفاظ على التنفس المنظم.",
        steps: [
          "حضّر خمس بطاقات لجمل قصيرة",
          "اطلب من الطفل استنشاق الهواء ثم قراءة الجملة ببطء",
          "منح نجمة لكل بطاقة تُقرأ دون استعجال",
        ],
        materials: ["بطاقات جمل", "صندوق بريد لعب"],
        durationMinutes: 10,
      },
    ],
  },
  {
    id: "q05-syllable-blending",
    question: "طفلي يجد صعوبة في مزج المقاطع لتكوين كلمة مفهومة",
    keywords: ["مزج", "مقاطع", "كلمات", "وعي صوتي"],
    reply:
      "اعمل على تمارين المزج التصاعدي؛ ابدأ بإسماع طفلك مقطعين منفصلين مثل \"با\" و\"ب\" ثم اطلب منه دمجهما ببطء. استخدم بطاقات مصوّرة تدل على الكلمة الناتجة لتحفيز الفهم، وكرّر التمرين بنفس الكلمة مع تغيير سرعة المزج حتى يكتسب ثقة كاملة.",
    simplified: "استمعوا للمقاطع منفصلة، دمجوها ببطء مع بطاقات مصوّرة، وزيدوا السرعة تدريجياً.",
    cues: ["استخدم بطاقات مصورة للكلمة الناتجة", "ابدأ بمقطعين فقط", "تحكّم بسرعة المزج"],
    nextActions: [
      "فعّل تمرين سلم الكلمات المتدرّج مع التركيز على مرحلة المقاطع.",
      "أدرج تمرين رحلة الأصوات في القصص بكلمات مركبة جديدة.",
      "سجّل صوت الطفل قبل وبعد التمرين للمقارنة الأسبوعية.",
    ],
    personalizedTips: [
      "شجع الطفل على التصفيق لكل مقطع قبل دمجه.",
      "استخدم أدوات حسية مثل مكعبات لتجسيد كل مقطع.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q06-voice-projection",
    question: "صوت ابنتي خافت جدًا عند القراءة، هل من تمارين؟",
    keywords: ["صوت", "خافت", "حجم", "قراءة"],
    reply:
      "ابدئي بتمارين تنفّس عميق متبوع بزفير طويل مع العد بصوت عالٍ. استخدمي تدريبات السلم الموسيقي البسيط (أصوات \"آ\" بدرجات مختلفة) لرفع الوعي بمستوى الصوت، ثم انتقلي إلى قراءة جمل قصيرة مع تحديد نقاط للتشديد الصوتي باستخدام بطاقات ملونة.",
    simplified: "نفَس عميق مع عدّ، غنّي الصوت \"آ\" بدرجات مختلفة، ثم شددي كلمات محددة أثناء القراءة.",
    cues: ["عدّ بصوت مسموع أثناء الزفير", "غيّري درجة صوت \"آ\"", "حددي كلمات للتشديد"],
    nextActions: [
      "طبّقي تمرين إيقاع التنفس والنطق قبل كل قراءة.",
      "استخدمي مسرح الظل لتجسيد القراءة بنبرة أقوى.",
      "سجّلوا القراءة واحتفلوا بأعلى ثلاث لحظات صوت واضح.",
    ],
    personalizedTips: [
      "ضعي مؤشرًا بصرياً (بطاقة نجمة) عند تحقيق صوت قوي لتحفيزها.",
      "استخدمي ألعاب تقليد الأصوات كالإعلاميين لرفع الثقة.",
    ],
    recommendedGames: [
      {
        title: "برنامج المذيعة الصغيرة",
        objective: "تقوية الإسقاط الصوتي عبر التقديم المسرحي",
        overview: "تقرأ الطفلة بطاقات أخبار قصيرة بنبرة ثابتة وواضحة أمام العائلة.",
        steps: [
          "اختاري ثلاث بطاقات أخبار مبسطة",
          "حددي كلمة للتشديد في كل بطاقة",
          "امنحي تقييمًا مشجعًا لكل تقديم واضح",
        ],
        materials: ["بطاقات أخبار", "ميكروفون لعبة"],
        durationMinutes: 9,
      },
    ],
  },
  {
    id: "q07-apraxia",
    question: "ابني يعاني من تعذّر التلفّظ الطفولي، ماذا أفعل في البيت؟",
    keywords: ["تعذر التلفظ", "أبراكسيا", "تسلسل حركي", "مقاطع"],
    reply:
      "ركز على تسلسل الحركات الفموية باستخدام إشارات بصرية؛ التقط صورًا لحركة اللسان والشفتين لكل صوت واعرضها بترتيب. ابدأ بالمقاطع البسيطة ثم كررها بإيقاع ثابت مع التربيت الخفيف على الكتف لمساعدة الدماغ على التنبّه للحركة. اجعل الجلسات قصيرة ومكررة خلال اليوم لزيادة التعلم الحركي.",
    simplified: "استخدم بطاقات حركية، كرر المقاطع بإيقاع ثابت مع تلامس خفيف، ونفّذ جلسات قصيرة متكررة.",
    cues: ["بطاقات توضح موضع اللسان", "تربيت خفيف على الكتف لتثبيت الإيقاع", "جلسات قصيرة لكن متكررة"],
    nextActions: [
      "استخدم تمرين المرآة الواعية مع الصور قبل النطق.",
      "ادمج مقاطع متسلسلة في تمرين سلم الكلمات المتدرّج.",
      "سجل أي تقدم في دفتر مرئي بالملصقات.",
    ],
    personalizedTips: [
      "تجنب الضغط على الطفل لإعادة المحاولة فورًا بعد الخطأ؛ امنحه ثلاث ثوانٍ.",
      "استعمل حركات يد متزامنة مع الصوت لتدعيم الذاكرة الحركية.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q08-rhythm-speech",
    question: "كيف أعلم طفلي التحدث بإيقاع ثابت دون تقطيع؟",
    keywords: ["إيقاع", "تقطيع", "طلاقة", "إلقاء"],
    reply:
      "استخدم مترو نوم بسيط أو تطبيق إيقاع يقدّم نقرات منتظمة، واطلب من طفلك نطق كلمات ثم جمل قصيرة متزامنة مع الإيقاع. كرر التمرين مع زيادة سرعة الإيقاع تدريجياً، ودمجه مع حركة جسدية بسيطة مثل التصفيق أو التربيت على الركبة لدعم الثبات.",
    simplified: "شغّل إيقاعًا ثابتًا، انطقوا الكلمات مع النقرات، وزيدوا السرعة مع حركة جسدية مساندة.",
    cues: ["مترو نوم أو تطبيق إيقاع", "التصفيق أثناء الكلام", "زيادة السرعة تدريجياً"],
    nextActions: [
      "جرّب مسرح الظل مع قرع خفيف أثناء الحوار.",
      "اختَر ثلاث جمل يومية وقلها مع التصفيق الإيقاعي.",
      "وثّق التقدم عبر مخطط بسيط لعدد التقطعات يومياً.",
    ],
    personalizedTips: [
      "اجعل جلسة التدريب صباحية حين يكون الطفل مرتاحاً.",
      "اسمح له باختيار كلمات يحبها ليشعر بالتحكم.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q09-vowel-errors",
    question: "طفلي يبدل الحركات القصيرة، كيف أصحح ذلك؟",
    keywords: ["حركات", "فتحة", "كسرة", "ضمة", "أصوات قصيرة"],
    reply:
      "استخدم بطاقات ملونة لكل حركة (أحمر للفتحة، أزرق للكسرة، أخضر للضمة) وعرّف طفلك على شكل الفم لكل حركة عبر المرآة. درّب المقاطع التي تحتوي الحركة المطلوبة ثم ضع البطاقات على كلمات واطلب منه قراءة كل كلمة مع رفع البطاقة الموافقة.",
    simplified: "ألوان للحركات، راقب شكل الفم، ثم اقرأ الكلمات ومعها البطاقة المناسبة.",
    cues: ["بطاقات ألوان مرتبطة بالحركات", "راقب شكل الفم قصير المدى", "كرر الكلمة مع البطاقة"],
    nextActions: [
      "طبّق تمرين صيد الأصوات في البيت للبحث عن كلمات بالحركة المستهدفة.",
      "أدخل حركة واحدة فقط في كل حصة لتثبيت التعلم.",
      "قيّم التقدم بتسجيل قراءة الكلمات قبل وبعد أسبوع.",
    ],
    personalizedTips: [
      "استعمل أغنية قصيرة لكل حركة لتسهيل التذكّر.",
      "أضف ملصقًا صغيرًا من نفس اللون على الأنشطة اليومية كتذكير.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q10-consonant-clusters",
    question: "ابني يحذف الحرف الثاني في المجموعات الساكنة مثل \"بر\" و\"سم\"",
    keywords: ["مجموعات ساكنة", "حذف", "مقطع", "حرفين"],
    reply:
      "ابدأ بتفكيك المجموعة الساكنة إلى حرفين ينطق كل منهما ببطء مع المحافظة على الاتصال الهوائي، ثم اجمعهما تدريجياً دون توقف. استخدم عصيّ الآيس كريم لتمثيل الحرفين وقربهما ببطء حتى يلتصقا بينما ينطق الطفل الصوتين معاً.",
    simplified: "انطق كل حرف ببطء، قرّب بينهما تدريجياً باستخدام عصي، ثم قل المقطع دون توقف.",
    cues: ["قسّم المجموعة الساكنة", "استعمل عصي لتمثيل الحرفين", "حافظ على تدفق الهواء"],
    nextActions: [
      "طبّق تمرين سلم الكلمات المتدرّج من المقطع إلى الكلمة.",
      "أدرج الكلمات في تمرين رحلة الأصوات في القصص لزيادة التكرار.",
      "التقط تسجيلًا أسبوعيًا لمقارنة وضوح المجموعات الساكنة.",
    ],
    personalizedTips: [
      "استعمل ألعاب بناء (ليغو) لتجسيد الجمع بين صوتين.",
      "حدّد ثلاث كلمات أساسية للتدرب اليومي.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  // Additional 20 entries will follow to exceed 30 in total
];

// Add more entries to reach at least 30 Q&A
const additionalEntries: KnowledgeBaseEntry[] = [
  {
    id: "q11-final-consonant",
    question: "طفلي يحذف الحرف الأخير من الكلمات، ما العمل؟",
    keywords: ["حرف أخير", "حذف", "نهاية الكلمة"],
    reply:
      "ركز على إبراز نهاية الكلمة باستخدام التصفير أو التصفيق عند الحرف الأخير. ادعم طفلك بصور تظهر الكلمة كاملة، ثم اسرد قصة قصيرة تتضمن كلمات تنتهي بنفس الصوت لتكراره في سياق ممتع.",
    simplified: "صفق للحرف الأخير، استخدم صورًا للكلمات، وكرّر الصوت في قصة قصيرة.",
    cues: ["تصفير عند الحرف الأخير", "بطاقات كلمات واضحة", "إعادة الصوت في القصة"],
    nextActions: [
      "نفّذ تمرين صيد الأصوات للتركيز على نهاية الكلمة.",
      "استعن بسلم الكلمات المتدرّج بإضافة نهاية الحرف تدريجيًا.",
      "سجّل طفلك وهو ينطق ثلاث كلمات قبل وبعد الجلسة.",
    ],
    personalizedTips: [
      "ضع ملصقًا بنجمة على كل كلمة يُنطق آخرها بنجاح.",
      "استخدم أصواتًا مضحكة عند نطق الحرف الأخير لجذب الانتباه.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q12-nasal-sounds",
    question: "كيف أعالج صعوبة نطق حرف النون والميم لدى ابنتي؟",
    keywords: ["نون", "ميم", "أنفي", "رنين"],
    reply:
      "اجعلي الطفلة تشعر بالاهتزاز عبر لمس أنفها أثناء نطق حرف \"م\" و\"ن\"، ثم انتقلي إلى كلمات قصيرة. استخدمي أغانٍ بسيطة تكرّر الأصوات الأنفية مع التصفيق على كل اهتزاز ناجح.",
    simplified: "المسي الأنف لرصد الاهتزاز، كرّري الكلمات القصيرة، وأضيفي أغنية بسيطة.",
    cues: ["تحسس الاهتزاز على الأنف", "ابدئي بكلمات أحادية المقطع", "استخدام الأغاني"],
    nextActions: [
      "ضعي تمرين المرآة الواعية لمراقبة الفم المغلق.",
      "ادمجي الصوت في حوار مسرحي قصير باستخدام مسرح الظل.",
      "وثّقي التقدم بمخطط ملون لكل جلسة ناجحة.",
    ],
    personalizedTips: [
      "ذكّريها باستنشاق الهواء من الأنف قبل النطق.",
      "اجعلي التدريب وقتاً ممتعاً مع أدوات موسيقية بسيطة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q13-oral-motor",
    question: "هل توجد تمارين فموية بسيطة لتحسين قوة اللسان؟",
    keywords: ["تمارين فموية", "قوة اللسان", "عضلات"],
    reply:
      "استعمل شفاطة قصيرة لشرب عصير كثيف، ثم اطلب من طفلك تحريك لسانه يميناً ويساراً بخطى بطيئة مع العد. أضف تمرين الضغط على اللسان بملعقة لمدة خمس ثوانٍ لتحسين التحمّل.",
    simplified: "استخدم شفاطة لعصير كثيف، حرّك اللسان يميناً ويساراً، واضغط عليه بملعقة.",
    cues: ["شفاطة قصيرة", "حركات جانبية بطيئة", "ضغط لمدة خمس ثوانٍ"],
    nextActions: [
      "وظّف تمرين المرآة الواعية بعد كل جلسة فموية.",
      "راقب الاستقامة باستخدام تسجيل فيديو قصير.",
      "اكتب ملاحظات التحسن في دفتر المتابعة الأسبوعي.",
    ],
    personalizedTips: [
      "احرص على تعقيم الأدوات بعد كل استخدام.",
      "حوّل التمرين إلى تحدٍ ممتع بعدم إسقاط العصير.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q14-autism-social",
    question: "طفلي على طيف التوحد يتفاعل بالكلمات لكن دون تواصل بصري، نصائح؟",
    keywords: ["توحد", "تواصل بصري", "نطق", "تفاعل"],
    reply:
      "استخدم بطاقات مشاعر ملوّنة لجذب نظره، واطلب منه تكرار الكلمة أثناء النظر إلى البطاقة. شجّعه على لمس البطاقة عندما ينطقها، وخصّص وقتًا للعب المشترك الذي يتضمن أدواراً كلامية واضحة.",
    simplified: "استعمل بطاقات مشاعر لجذب النظر، ألمس البطاقة أثناء النطق، واعتمد لعب الأدوار.",
    cues: ["بطاقات مشاعر ملونة", "لمس البطاقة عند النطق", "أدوار كلامية قصيرة"],
    nextActions: [
      "ادمج تمرين مسرح الظل لتخصيص أدوار بسيطة.",
      "سجّل اللحظات التي ينظر فيها إليك واشكره فورًا.",
      "استخدم سلم الكلمات المتدرّج لجمل روتينية.",
    ],
    personalizedTips: [
      "قدّم المكافأة فور تحقيق التواصل البصري حتى لو كان ثانيتين.",
      "استخدم العناصر المفضلة لديه داخل التمرين.",
    ],
    recommendedGames: [
      {
        title: "أبطال المشاعر",
        objective: "تعزيز التواصل البصري والكلامي باستخدام بطاقات تعبيرية",
        overview: "يختار الطفل بطاقة شعور وينطق الجملة المرتبطة مع النظر إلى المرافق.",
        steps: [
          "اختَر خمس بطاقات مشاعر",
          "ألف جملة قصيرة لكل بطاقة",
          "امنح مكافأة عند الجمع بين النظر والنطق",
        ],
        materials: ["بطاقات مشاعر", "ملصقات مكافأة"],
        durationMinutes: 7,
      },
    ],
  },
  {
    id: "q15-phonological-process",
    question: "ابني يستبدل جميع الأصوات الخلفية بالأمامية، ما الخطة؟",
    keywords: ["أصوات خلفية", "ك", "ج", "تحويل"],
    reply:
      "ابدأ بالتمييز السمعي بين كلمتين مثل \"كأس\" و\"تأس\" لتوضيح الفرق، ثم استخدم أدوات لمسية كملعقة خشبية تلمس الجزء الخلفي من الحنك عند نطق الكاف. انتقِل تدريجياً من الصوت المفرد إلى الكلمة ثم الجملة.",
    simplified: "ميّز سمعيًا بين الصوتين، المس الحنك الخلفي عند نطق الكاف، ثم ابنِ كلمات وجملاً.",
    cues: ["أزواج كلمات متقابلة", "ملعقة تلمس الحنك الخلفي", "تدرّج من صوت إلى جملة"],
    nextActions: [
      "وظّف تمرين المرآة الواعية مع التركيز على رفع اللسان للخلف.",
      "ادمج الأصوات في تمرين سلم الكلمات المتدرّج.",
      "اتبع تمرين رحلة الأصوات بقصص عن المطبخ (كلمات \"ك\").",
    ],
    personalizedTips: [
      "استخدم كلمات تحبها الطفل وتحتوي الصوت الخلفي.",
      "ثابِر على جلسات قصيرة يومية بدلاً من جلسة طويلة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q16-rapid-speech",
    question: "طفلي يتحدث بسرعة فائقة يصعب فهمها",
    keywords: ["سرعة", "كلام سريع", "وضوح"],
    reply:
      "عرّف طفلك على تقنية \"الكلمات الملونة\" حيث يلوّن كل كلمة بلون مختلف على البطاقة ثم يقرأها ببطء مع لمس اللون. استخدم مؤقتاً بصرياً لتحديد زمن مناسب لكل جملة وكررها حتى يحافظ على الإيقاع.",
    simplified: "لوّن الكلمات، المس اللون عند القراءة، واستعمل مؤقتًا بصريًا لإبطاء الكلام.",
    cues: ["بطاقات كلمات ملونة", "مؤقت بصري", "لمس اللون أثناء القراءة"],
    nextActions: [
      "قم بإشراك تمرين إيقاع التنفس والنطق قبل كل حوار.",
      "سجل مقاطع فيديو قصيرة لمراجعة السرعة مع الطفل.",
      "أدخل مسرح الظل لتمثيل نص بطيء الإيقاع.",
    ],
    personalizedTips: [
      "استخدم إشارة يد للاتفاق على تقليل السرعة أثناء الحديث.",
      "امتدح لحظات البطء الواضح فور حدوثها.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q17-clarity-after-braces",
    question: "بعد تركيب تقويم الأسنان تغير وضوح نطق ابنتي",
    keywords: ["تقويم", "أسنان", "وضوح", "تكيف"],
    reply:
      "امنحها وقتًا للتأقلم عبر تمارين فموية خفيفة مثل تمرير اللسان حول الأقواس بخفة. ركّز على الأصوات التي تتأثر بالتقويم كالسين واللام باستخدام المرآة والتكرار البطيء، وسجّل تقدمها أسبوعياً.",
    simplified: "نفّذ تمارين فموية لطيفة، درّب الأصوات المتأثرة ببطء، وراقب التقدم أسبوعيًا.",
    cues: ["تمرين اللسان حول الأقواس", "مرآة لتصحيح موضع اللسان", "تسجيل أسبوعي"],
    nextActions: [
      "طبّق تمرين المرآة الواعية مع التركيز على الاحتكاك بالأسنان.",
      "استخدم سلم الكلمات المتدرّج للكلمات اليومية.",
      "راجِع مع أخصائية التقويم إن ظهرت آلام تمنع النطق الصحيح.",
    ],
    personalizedTips: [
      "استخدمي ماء دافئ قبل التمرين لتخفيف الضغط.",
      "استبدلي الكلمات الصعبة مؤقتاً بأخرى أسهل للحفاظ على الثقة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q18-speech-delay-toddler",
    question: "طفلتي في عمر 3 سنوات تتكلم كلمات قليلة فقط",
    keywords: ["تأخر لغوي", "3 سنوات", "مفردات"],
    reply:
      "كثّفي التكرار الوظيفي للكلمات اليومية مع الإشارة للأشياء، واستعملي استراتيجية \"الحديث الموازي\" بوصف ما تقوم به الطفلة بصوت عالٍ. أضيفي نشاطات حسية مثل لمس الأشياء أثناء تسميتها لتعزيز الارتباط.",
    simplified: "كرري الكلمات اليومية، استخدمي الحديث الموازي، وأضيفي نشاطات حسية مع التسمية.",
    cues: ["كرر الكلمة ثلاث مرات", "صف ما تفعله الطفلة", "استخدم حواس متعددة"],
    nextActions: [
      "طبّقي تمرين صيد الأصوات في البيت للأشياء المفضلة.",
      "أدخلي حركات يد بسيطة أثناء النطق لتثبيت الذاكرة.",
      "تابعي دفتر مفردات يزداد أسبوعياً.",
    ],
    personalizedTips: [
      "استخدمي صور أفراد العائلة لزيادة التفاعل.",
      "قدمي المكافأة فور محاولتها إنشاء كلمة جديدة.",
    ],
    recommendedGames: [
      {
        title: "كنز الكلمات الأولى",
        objective: "توسيع المفردات عبر البحث عن أغراض يومية",
        overview: "تبحث الطفلة عن غرض يسمّى بصوت عالٍ، ثم تضعه في صندوق الكنز بعد تكراره ثلاث مرات.",
        steps: [
          "اختاري خمسة أغراض مألوفة",
          "سمّي الغرض واطلبي تكراره",
          "ضعي الغرض في الصندوق بعد النطق",
        ],
        materials: ["صندوق", "أغراض منزلية"],
        durationMinutes: 8,
      },
    ],
  },
  {
    id: "q19-school-anxiety",
    question: "طفلي يتوتر قبل تقديم العروض المدرسية",
    keywords: ["توتر", "عرض", "مدرسة", "تحضير"],
    reply:
      "اصنع سيناريو تدريبيًا في المنزل يشبه صف المدرسة، واستخدم مؤقتًا بصريًا لتقسيم العرض إلى مقاطع قصيرة. عزّز ثقته من خلال تعليقات إيجابية محددة بعد كل مقطع، وادعُ فردًا من العائلة ليكون جمهورًا داعمًا.",
    simplified: "أنشئ عرضًا تجريبيًا، استخدم مؤقتًا بصريًا، وقدّم تغذية راجعة إيجابية بعد كل جزء.",
    cues: ["بيئة عرض تدريبية", "مؤقت بصري", "تعليقات محددة إيجابية"],
    nextActions: [
      "نفّذ تمرين مسرح الظل لتمثيل العرض قبل الموعد.",
      "ضمّن تمرين إيقاع التنفس والنطق قبل البدء.",
      "سجّل الفيديو واسمح له بمشاهدته معك لنقد بناء.",
    ],
    personalizedTips: [
      "اكتب ثلاث جمل تشجيعية يقرأها الطفل لنفسه قبل العرض.",
      "استخدم وسيلة تهدئة (كرة ضغط) أثناء الانتظار.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q20-hoarseness",
    question: "ابني صوته مبحوح دائماً، هل هذا يؤثر على النطق؟",
    keywords: ["بحة", "صوت", "حبال صوتية"],
    reply:
      "الحفاظ على رطوبة الحبال الصوتية ضروري؛ شجّع طفلك على شرب الماء الفاتر وتجنب الصراخ. استخدم تمارين تنعيم الصوت مثل إصدار همهمة منخفضة لمدة عشر ثوانٍ قبل جلسة النطق.",
    simplified: "اشرب ماءً فاترًا، تجنب الصراخ، وابدأ بالهمهمة لتدفئة الصوت.",
    cues: ["ماء فاتر طوال اليوم", "همهمة عشر ثوانٍ", "تجنب رفع الصوت"],
    nextActions: [
      "أجرِ تمرين إيقاع التنفس والنطق بعد الهمهمة.",
      "راقب رطوبة الصوت بتسجيل يومي قصير.",
      "استشر طبيب أنف وأذن إذا استمرت البحة أكثر من أسبوعين.",
    ],
    personalizedTips: [
      "علّم الطفل استخدام إشارة ياقوتية لتذكيره بخفض الصوت.",
      "قدّم مشروباً دافئاً خالياً من الكافيين قبل التدريب.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q21-routine-home",
    question: "كيف أضع روتينًا منزليًا لجلسات النطق اليومية؟",
    keywords: ["روتين", "منزلي", "جلسات", "تنظيم"],
    reply:
      "حدد وقتًا ثابتًا لا يتجاوز عشر دقائق بعد وجبة خفيفة حين يكون الطفل مرتاحًا. قسّم الجلسة إلى ثلاث مراحل: تنفّس وإحماء، نطق الصوت أو الكلمة، تطبيق في جملة أو لعبة. دوّن نتائج الجلسة في جدول بسيط مع ملصق للنجاح.",
    simplified: "اختر وقتًا ثابتًا، قسّم الجلسة إلى إحماء وصوت وتطبيق، وسجّل النتائج في جدول.",
    cues: ["جلسة عشر دقائق", "ثلاث مراحل واضحة", "سجل إنجازات"],
    nextActions: [
      "استخدم تمرين المرآة الواعية في مرحلة الإحماء.",
      "ادمج تمرين صيد الأصوات خلال التطبيق.",
      "راجع التقدم أسبوعيًا مع الطفل لتعزيز الالتزام.",
    ],
    personalizedTips: [
      "ضع الجلسة في وقت خالٍ من الشاشات.",
      "استعمل مؤقتًا بالرمل ليعرف الطفل مدة التدريب المتبقية.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q22-dysarthria",
    question: "طفلي لديه ضعف عضلي يؤثر على النطق (ديسارثريا)",
    keywords: ["ديسارثريا", "ضعف عضلي", "تمارين"],
    reply:
      "اعتمد تدريبات فموية ذات مقاومة خفيفة مثل نفخ كرة قطنية عبر الشفاه، ثم نطق مقاطع قصيرة مع ترتيب اللسان بمساعدة ملعقة. ركّز على البطء والوضوح مع تسجيل تقدم بسيط.",
    simplified: "نفخ كرة قطنية، استخدم ملعقة لتوجيه اللسان، وتكلم ببطء مع تسجيل التقدم.",
    cues: ["كرة قطنية للمقاومة", "ملعقة لتوجيه اللسان", "بطء مقصود"],
    nextActions: [
      "أدمج تمرين المرآة الواعية لمراقبة الحركة.",
      "استخدم تمرين إيقاع التنفس والنطق لتقوية التنسيق.",
      "تابع مع الأخصائي للتأكد من اختيار التمارين الآمنة.",
    ],
    personalizedTips: [
      "ابدأ بمقاومة خفيفة وزدها تدريجيًا.",
      "أفسح وقتًا للراحة بين المحاولات لتفادي الإرهاق.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q23-bilingual",
    question: "نعيش في بيئة ثنائية اللغة، كيف أحافظ على اتساق النطق؟",
    keywords: ["ثنائية اللغة", "لغتين", "اتساق"],
    reply:
      "خصص لكل لغة وقتًا محددًا في اليوم، وركز على الأصوات المشتركة أولاً لضمان الاستقرار. استخدم بطاقات تحدد اللغة الحالية وتحدث بصوت واضح مع تكرار الكلمات الصعبة في كلا السياقين.",
    simplified: "حدّد وقتًا لكل لغة، ركّز على الأصوات المشتركة، واستخدم بطاقات تدل على اللغة الحالية.",
    cues: ["تقسيم زمني لكل لغة", "أصوات مشتركة أولاً", "بطاقات تحدد اللغة"],
    nextActions: [
      "نفّذ تمرين رحلة الأصوات بلغتين منفصلتين خلال الأسبوع.",
      "سجل مقاطع قصيرة بكل لغة لقياس التحسن.",
      "اطلب من أفراد العائلة الالتزام بلغة الجلسة المحددة.",
    ],
    personalizedTips: [
      "اختر أغاني مفضلة بكل لغة لتسهيل الانتقال.",
      "تجنب خلط اللغتين في الجملة نفسها أثناء التدريب.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q24-signals",
    question: "هل أستخدم إشارات يدوية لدعم نطق الأصوات؟",
    keywords: ["إشارات يدوية", "دعم", "سياق بصري"],
    reply:
      "استخدم إشارات بسيطة تمثل حركة اللسان أو مكان الصوت، مثل رفع الإصبع للسقف للدلالة على الأصوات الخلفية. كرر الإشارة مع الصوت حتى يربط الطفل بينهما، ثم خفف استخدامها تدريجيًا عندما يتحسن النطق.",
    simplified: "اصنع إشارات تمثل مكان الصوت، كررها مع النطق، ثم خففها تدريجيًا.",
    cues: ["إشارة لكل صوت", "تكرار متزامن", "إزالة تدريجية"],
    nextActions: [
      "ادمج الإشارة في تمرين المرآة الواعية.",
      "سجل فيديو قصير لاستخدام الإشارة كمرجع.",
      "اختر ثلاث أصوات فقط للبدء كي لا يتشتت الطفل.",
    ],
    personalizedTips: [
      "اجعل الإشارة بسيطة ويمكن تنفيذها بيد واحدة.",
      "شارك المدرسة بالإشارات المستخدمة لضمان الاتساق.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q25-oral-sensory",
    question: "طفلي حساس جدًا للمس داخل الفم، هل يمكن تنفيذ التمارين؟",
    keywords: ["حساسية", "فم", "لمس"],
    reply:
      "ابدأ بتحسس خارجي لطيف حول الشفاه باستخدام فرشاة ناعمة، ثم تقدّم تدريجيًا نحو الداخل. استخدم الجل البارد لتخفيف الحساسية قبل التمرين النطقي، واسمح للطفل بالتحكم في درجة اللمس.",
    simplified: "ابدأ بتحسس خارجي، استخدم جلًا باردًا، واترك الطفل يحدد شدة اللمس.",
    cues: ["تفريش لطيف خارج الفم", "جل بارد قبل التمرين", "تحكم الطفل باللمس"],
    nextActions: [
      "انتقل إلى تمرين المرآة الواعية بمجرد تراجع الحساسية.",
      "اطلب من الطفل تقييم راحته بعد كل جلسة.",
      "استشر أخصائي علاج وظيفي إذا استمرت الحساسية العالية.",
    ],
    personalizedTips: [
      "استخدم نكهات محايدة لتجنب النفور.",
      "أضف عنصر اللعب مثل رسم الابتسامة بالفرشاة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q26-night-practice",
    question: "هل من المفيد التدريب قبل النوم؟",
    keywords: ["قبل النوم", "تدريب", "ذاكرة"],
    reply:
      "جلسة خفيفة قبل النوم يمكن أن تعزز التثبيت، شرط أن تكون مهدئة. ركز على مراجعة سريعة لما تم تعلمه خلال النهار مع ختم الجلسة بجملة تشجيعية وأخذ نفس عميق.",
    simplified: "نعم، جلسة قصيرة هادئة قبل النوم تعزز التثبيت مع تشجيع ونفس عميق.",
    cues: ["جلسة قصيرة", "هدوء وإضاءة خافتة", "جملة تشجيعية"],
    nextActions: [
      "استخدم تمرين إيقاع التنفس والنطق السريع.",
      "راجع ثلاث كلمات أساسية فقط.",
      "دوّن ملاحظة إيجابية في دفتر الإنجازات قبل النوم.",
    ],
    personalizedTips: [
      "أغلق الشاشات قبل الجلسة لتهيئة الدماغ.",
      "استخدم نبرة صوت هادئة ومطمئنة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q27-progress-plateau",
    question: "التقدم متوقف منذ أسابيع، ماذا أفعل؟",
    keywords: ["توقف", "تقدم", "ركود", "تحفيز"],
    reply:
      "غيّر ترتيب التمارين وأدخل عنصرًا جديدًا مثل تسجيل فيديو أو لعبة تنافسية ليوم واحد. استشر الأخصائي لمراجعة الأهداف، وقيّم التقدم بمؤشرات أصغر مثل دقة الصوت في مقطع واحد بدلاً من جملة كاملة.",
    simplified: "عدّل التمارين، أضف عنصرًا جديدًا، وقيّم تقدمًا أصغر بالتعاون مع الأخصائي.",
    cues: ["تنويع التمارين", "عنصر جديد محفز", "أهداف صغيرة"],
    nextActions: [
      "جرّب لعبة صائد الأصوات بنظام نقاط جديد.",
      "عد إلى تمرين المرآة الواعية للتأكد من الأساسيات.",
      "حدد هدفًا أسبوعيًا واحدًا فقط.",
    ],
    personalizedTips: [
      "اشرك الطفل في اختيار التمرين الجديد.",
      "احتفل بإنجازات بسيطة لإعادة الثقة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q28-speech-generalization",
    question: "طفلي ينطق الصوت جيدًا في التدريب لكن ليس في المدرسة",
    keywords: ["تعميم", "مدرسة", "بيئات مختلفة"],
    reply:
      "اعمل على سيناريوهات حقيقية تشبه المدرسة ضمن التدريب، ونسّق مع المعلمة لتقديم إشارات خفية (مثل وضع يد على القلب) لتذكيره بالنطق الصحيح. دوّن في جدول متى نجح في التعميم واحتفل به.",
    simplified: "حاكي مواقف المدرسة، نسّق إشارة خفية مع المعلمة، واحتفل بكل تعميم ناجح.",
    cues: ["سيناريوهات واقعية", "إشارة متفق عليها", "جدول تعميم"],
    nextActions: [
      "نفّذ مسرح الظل لمحاكاة الحوار المدرسي.",
      "أعد تمرين صيد الأصوات باستخدام أدوات المدرسة.",
      "شارك الطفل الجدول الأسبوعي للتعميم.",
    ],
    personalizedTips: [
      "أرسل مقطعًا صوتيًا قصيرًا للأخصائي عند الحاجة للمشورة.",
      "كافئ نجاح التعميم فورًا بشارة صغيرة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q29-parent-selfcare",
    question: "كيف أحافظ على استمرارية التدريب دون إرهاق؟",
    keywords: ["ولي الأمر", "إرهاق", "استمرارية"],
    reply:
      "حدّد أيام راحة واضحة في الجدول وشارك مهام التدريب مع فرد آخر إن أمكن. استخدم تطبيق متابعة بسيط لتتبع التقدم وتذكير نفسك بأن الهدف هو التحسين التدريجي لا الكمال.",
    simplified: "حدد أيام راحة، وزّع المهام، وركّز على التحسن التدريجي عبر تطبيق متابعة.",
    cues: ["أيام راحة", "تقاسم التدريب", "متابعة تدريجية"],
    nextActions: [
      "أعد تقييم الأهداف شهريًا مع الأخصائي.",
      "استعمل جدولاً بصريًا يعرض أيام التدريب والراحة.",
      "كافئ نفسك وطفلك بنشاط ممتع بعد كل أسبوع ملتزم.",
    ],
    personalizedTips: [
      "تذكّر أن تقصير الجلسة أفضل من إلغائها عند التعب.",
      "اطلب الدعم من مجموعات أولياء الأمور عند الحاجة.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
  {
    id: "q30-resources",
    question: "ما الموارد الرقمية الآمنة لتعزيز التدريب؟",
    keywords: ["موارد رقمية", "تطبيقات", "آمنة"],
    reply:
      "اختر تطبيقات موثوقة من مؤسسات علاج النطق المعروفة وتأكد من خلوها من الإعلانات المشتتة. خصص وقتًا قصيرًا يوميًا لمراجعة درس افتراضي ثم طبق التمرين نفسه يدويًا لتعزيز التعميم.",
    simplified: "استخدم تطبيقات موثوقة بلا إعلانات، وطبّق التمرين يدويًا بعد الجلسة الرقمية.",
    cues: ["تطبيقات موثوقة", "وقت قصير يوميًا", "تطبيق يدوي لاحق"],
    nextActions: [
      "قيّم فعالية التطبيق أسبوعيًا مع طفلك.",
      "ادمج تمرين صيد الأصوات لتطبيق المهارة الواقعية.",
      "حدّد قاعدة استخدام الشاشة قبل وبعد التطبيق.",
    ],
    personalizedTips: [
      "راجع تقييمات الأخصائيين قبل تنزيل أي تطبيق.",
      "شارك المدرسة بالتطبيق لتكامل الجهود.",
    ],
    recommendedGames: [DEFAULT_GAME],
  },
];

const FULL_KNOWLEDGE_BASE: KnowledgeBaseEntry[] = [...KNOWLEDGE_BASE, ...additionalEntries];

export const KNOWLEDGE_BASE_SIZE = FULL_KNOWLEDGE_BASE.length;

const scoreEntry = (questionTokens: string[], entry: KnowledgeBaseEntry) => {
  const entryTokens = new Set([...entry.keywords.map(normalizeText), ...tokenize(entry.question)]);
  let overlap = 0;
  questionTokens.forEach((token) => {
    if (entryTokens.has(token)) {
      overlap += 2;
    } else if (token.length > 3) {
      // partial match heuristic
      entryTokens.forEach((candidate) => {
        if (candidate.includes(token) || token.includes(candidate)) {
          overlap += 1;
        }
      });
    }
  });
  const lengthPenalty = Math.max(questionTokens.length, entryTokens.size) || 1;
  return overlap / lengthPenalty;
};

export const matchKnowledgeBase = (question: string) => {
  const tokens = tokenize(question);
  if (tokens.length === 0) {
    return null;
  }
  let bestEntry: KnowledgeBaseEntry | null = null;
  let bestScore = 0;

  FULL_KNOWLEDGE_BASE.forEach((entry) => {
    const score = scoreEntry(tokens, entry);
    if (score > bestScore) {
      bestScore = score;
      bestEntry = entry;
    }
  });

  if (!bestEntry) {
    return null;
  }

  const recommendedExercises =
    bestEntry.recommendedExercises && bestEntry.recommendedExercises.length > 0
      ? bestEntry.recommendedExercises
      : BASE_EXERCISES;

  const response: Pick<
    HomeLearningAssistantMessageResponse,
    "reply" | "simplifiedReply" | "cues" | "nextActions" | "personalizedTips" | "recommendedGames" | "recommendedExercises"
  > = {
    reply: bestEntry.reply,
    simplifiedReply: bestEntry.simplified,
    cues: bestEntry.cues,
    nextActions: bestEntry.nextActions,
    personalizedTips: bestEntry.personalizedTips,
    recommendedGames: bestEntry.recommendedGames,
    recommendedExercises,
  };

  return response;
};

export const getDefaultExercises = () => BASE_EXERCISES;
